<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Audio2Text Whisper Studio</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Plus Jakarta Sans", "Inter", system-ui, -apple-system, sans-serif;
        --bg: #f7f8fb;
        --card: #ffffff;
        --text: #0f172a;
        --muted: #5b6474;
        --primary: #3b82f6;
        --primary-dark: #2563eb;
        --border: #e2e8f0;
        --shadow: 0 20px 40px rgba(15, 23, 42, 0.12);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
      }
      main {
        max-width: 1080px;
        margin: 0 auto;
        padding: 48px 24px 96px;
        display: grid;
        gap: 32px;
      }
      header {
        display: grid;
        gap: 16px;
      }
      .hero {
        display: grid;
        gap: 12px;
      }
      h1 {
        font-size: clamp(2.3rem, 3vw, 3rem);
        margin: 0;
      }
      .subhead {
        font-size: 1.05rem;
        color: var(--muted);
        margin: 0;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #e0f2fe;
        color: #0369a1;
        border-radius: 999px;
        padding: 6px 14px;
        font-weight: 600;
        width: fit-content;
      }
      .grid {
        display: grid;
        gap: 24px;
      }
      @media (min-width: 880px) {
        .grid {
          grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
        }
      }
      .card {
        background: var(--card);
        border-radius: 20px;
        padding: 24px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
      }
      .card h2 {
        margin: 0 0 8px;
        font-size: 1.3rem;
      }
      .steps {
        display: grid;
        gap: 16px;
      }
      .step {
        display: flex;
        gap: 12px;
        align-items: flex-start;
      }
      .step span {
        width: 32px;
        height: 32px;
        border-radius: 10px;
        background: #dbeafe;
        color: #1d4ed8;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
      }
      .drop-zone {
        border: 2px dashed #cbd5f5;
        border-radius: 18px;
        padding: 24px;
        text-align: center;
        background: #f8fafc;
        transition: border-color 0.2s ease, background 0.2s ease;
        display: grid;
        gap: 12px;
      }
      .drop-zone.dragover {
        border-color: var(--primary);
        background: #eff6ff;
      }
      .drop-zone input {
        display: none;
      }
      .drop-action {
        font-weight: 600;
        color: var(--primary-dark);
        text-decoration: underline;
        cursor: pointer;
      }
      .file-meta {
        font-size: 0.95rem;
        color: var(--muted);
      }
      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }
      button {
        border: none;
        border-radius: 14px;
        padding: 12px 18px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .primary {
        background: var(--primary);
        color: white;
        box-shadow: 0 12px 20px rgba(59, 130, 246, 0.25);
      }
      .secondary {
        background: #eef2ff;
        color: #3730a3;
      }
      .ghost {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text);
      }
      .primary:hover:not(:disabled),
      .secondary:hover:not(:disabled),
      .ghost:hover:not(:disabled) {
        transform: translateY(-1px);
      }
      .status {
        font-size: 0.95rem;
        color: var(--muted);
      }
      .status.error {
        color: #dc2626;
      }
      .status-panel {
        border-radius: 14px;
        border: 1px solid var(--border);
        padding: 14px 16px;
        background: #f8fafc;
        display: grid;
        gap: 10px;
      }
      .status-row {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        font-size: 0.92rem;
        color: var(--muted);
      }
      .status-row strong {
        color: var(--text);
        font-weight: 600;
        text-align: right;
      }
      .status-detail {
        margin-top: 8px;
        padding: 10px 12px;
        background: #fff1f2;
        border: 1px solid #fecdd3;
        color: #b91c1c;
        border-radius: 12px;
        font-size: 0.92rem;
      }
      textarea {
        width: 100%;
        min-height: 280px;
        border-radius: 16px;
        border: 1px solid var(--border);
        padding: 16px;
        font-size: 1rem;
        resize: vertical;
      }
      .hint {
        font-size: 0.9rem;
        color: var(--muted);
      }
      details {
        border: 1px dashed var(--border);
        border-radius: 16px;
        padding: 12px 16px;
      }
      details summary {
        cursor: pointer;
        font-weight: 600;
      }
      .field {
        display: grid;
        gap: 8px;
        margin-top: 12px;
      }
      .field input,
      .field textarea {
        border-radius: 12px;
        border: 1px solid var(--border);
        padding: 10px 12px;
        font-size: 0.95rem;
      }
      .transcript-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-top: 12px;
      }
      .audio-preview {
        width: 100%;
      }
    </style>
  </head>
  <body>
    <main>
      <header>
        <div class="pill">Secure Whisper proxy via Netlify Functions</div>
        <div class="hero">
          <h1>Ship your audio to Whisper and get a clean transcript back.</h1>
          <p class="subhead">
            Upload a recording, send it through the Netlify function, and copy the transcript
            when it returns. Works with MP3, WAV, M4A, FLAC, and more.
          </p>
        </div>
      </header>

      <div class="grid">
        <section class="card">
          <h2>Upload audio</h2>
          <p class="hint">
            Keep files under 25MB for the fastest turnaround (Netlify function limits apply).
          </p>
          <form id="transcribe-form">
            <div class="drop-zone" id="drop-zone">
              <input
                id="audio-input"
                name="audio"
                type="file"
                accept="audio/mpeg,audio/mp3,audio/wav,audio/x-wav,audio/flac,audio/ogg,audio/mp4,audio/x-m4a"
                required
              />
              <div>
                Drag & drop your audio here or
                <label class="drop-action" for="audio-input">browse files</label>
              </div>
              <div class="file-meta" id="file-meta">No file selected yet.</div>
              <audio class="audio-preview" id="audio-preview" controls hidden></audio>
            </div>

            <details>
              <summary>Advanced options</summary>
              <div class="field">
                <label for="language">Language hint (optional)</label>
                <input
                  id="language"
                  name="language"
                  placeholder="e.g. en, es, fr"
                />
                <span class="hint">Provide a two-letter language code to improve accuracy.</span>
              </div>
              <div class="field">
                <label for="prompt">Vocabulary prompt (optional)</label>
                <textarea
                  id="prompt"
                  name="prompt"
                  rows="3"
                  placeholder="Add names or terminology to improve accuracy"
                ></textarea>
              </div>
            </details>

            <div class="controls">
              <button class="primary" id="transcribe-button" type="submit">Transcribe</button>
              <button class="ghost" id="reset-button" type="button">Clear</button>
            </div>
            <div class="status" id="status">Ready when you are.</div>
            <div class="status-panel">
              <div class="status-row">
                <span>File</span>
                <strong id="status-file">No file selected</strong>
              </div>
              <div class="status-row">
                <span>Upload</span>
                <strong id="status-upload">Waiting</strong>
              </div>
              <div class="status-row">
                <span>Whisper request</span>
                <strong id="status-request">—</strong>
              </div>
            </div>
            <div class="status-detail" id="status-detail" hidden></div>
          </form>
        </section>

        <section class="card">
          <h2>Transcript</h2>
          <textarea id="transcript" placeholder="Your transcript will appear here..." readonly></textarea>
          <div class="transcript-actions">
            <button class="secondary" id="copy-button" type="button" disabled>Copy text</button>
            <button class="secondary" id="download-button" type="button" disabled>Download .txt</button>
          </div>
        </section>
      </div>

      <section class="card">
        <h2>How it works</h2>
        <div class="steps">
          <div class="step">
            <span>1</span>
            <div>
              <strong>Upload your audio.</strong>
              <p class="hint">
                Your browser sends the file to a Netlify Function, which holds the API key.
              </p>
            </div>
          </div>
          <div class="step">
            <span>2</span>
            <div>
              <strong>Let Whisper transcribe.</strong>
              <p class="hint">
                The function calls OpenAI Whisper and returns the transcript plus a request id.
              </p>
            </div>
          </div>
          <div class="step">
            <span>3</span>
            <div>
              <strong>Copy or download.</strong>
              <p class="hint">Save it as text or paste it into your workflow.</p>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script>
      const form = document.getElementById("transcribe-form");
      const audioInput = document.getElementById("audio-input");
      const statusEl = document.getElementById("status");
      const transcriptEl = document.getElementById("transcript");
      const copyButton = document.getElementById("copy-button");
      const downloadButton = document.getElementById("download-button");
      const transcribeButton = document.getElementById("transcribe-button");
      const resetButton = document.getElementById("reset-button");
      const statusFile = document.getElementById("status-file");
      const statusUpload = document.getElementById("status-upload");
      const statusRequest = document.getElementById("status-request");
      const statusDetail = document.getElementById("status-detail");
      const dropZone = document.getElementById("drop-zone");
      const fileMeta = document.getElementById("file-meta");
      const audioPreview = document.getElementById("audio-preview");
      const languageInput = document.getElementById("language");
      const promptInput = document.getElementById("prompt");
      const MAX_UPLOAD_MB = 25;

      const setStatus = (message, isError = false, detail = "") => {
        statusEl.textContent = message;
        statusEl.classList.toggle("error", isError);
        statusDetail.textContent = detail;
        statusDetail.hidden = !detail;
      };

      const formatBytes = (bytes) => {
        if (!bytes) return "0 bytes";
        const units = ["bytes", "KB", "MB", "GB"];
        const index = Math.min(Math.floor(Math.log(bytes) / Math.log(1024)), units.length - 1);
        const value = bytes / Math.pow(1024, index);
        return `${value.toFixed(value >= 10 || index === 0 ? 0 : 1)} ${units[index]}`;
      };

      const resetFormState = () => {
        form.reset();
        transcriptEl.value = "";
        audioPreview.src = "";
        audioPreview.hidden = true;
        fileMeta.textContent = "No file selected yet.";
        copyButton.disabled = true;
        downloadButton.disabled = true;
        transcribeButton.disabled = false;
        statusFile.textContent = "No file selected";
        statusUpload.textContent = "Waiting";
        statusRequest.textContent = "—";
        setStatus("Ready when you are.");
      };

      const setFile = (file) => {
        if (!file) return;
        if (file.size > MAX_UPLOAD_MB * 1024 * 1024) {
          audioInput.value = "";
          fileMeta.textContent = "No file selected yet.";
          audioPreview.src = "";
          audioPreview.hidden = true;
          statusFile.textContent = "No file selected";
          statusUpload.textContent = "Waiting";
          statusRequest.textContent = "—";
          setStatus(
            `File is too large. Please upload a file under ${MAX_UPLOAD_MB}MB.`,
            true
          );
          return;
        }
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        audioInput.files = dataTransfer.files;
        fileMeta.textContent = `${file.name} · ${formatBytes(file.size)}`;
        statusFile.textContent = `${file.name} (${formatBytes(file.size)})`;
        statusUpload.textContent = "Waiting";
        statusRequest.textContent = "—";
        audioPreview.src = URL.createObjectURL(file);
        audioPreview.hidden = false;
      };

      dropZone.addEventListener("dragover", (event) => {
        event.preventDefault();
        dropZone.classList.add("dragover");
      });

      dropZone.addEventListener("dragleave", () => {
        dropZone.classList.remove("dragover");
      });

      dropZone.addEventListener("drop", (event) => {
        event.preventDefault();
        dropZone.classList.remove("dragover");
        const file = event.dataTransfer.files[0];
        if (file) {
          setFile(file);
        }
      });

      audioInput.addEventListener("change", () => {
        const file = audioInput.files[0];
        if (file) {
          setFile(file);
        }
      });

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!audioInput.files.length) {
          setStatus("Please choose an audio file to transcribe.", true);
          return;
        }

        const formData = new FormData();
        formData.append("audio", audioInput.files[0]);
        if (languageInput.value.trim()) {
          formData.append("language", languageInput.value.trim());
        }
        if (promptInput.value.trim()) {
          formData.append("prompt", promptInput.value.trim());
        }

        transcriptEl.value = "";
        statusUpload.textContent = "Uploading";
        statusRequest.textContent = "—";
        setStatus("Uploading audio and generating transcript...");
        copyButton.disabled = true;
        downloadButton.disabled = true;
        transcribeButton.disabled = true;

        try {
          const response = await fetch("/.netlify/functions/transcribe", {
            method: "POST",
            body: formData,
          });
          const responseText = await response.text();
          let payload = {};
          try {
            payload = responseText ? JSON.parse(responseText) : {};
          } catch (error) {
            payload = { error: responseText };
          }

          const requestId = payload.requestId || "—";
          statusRequest.textContent = requestId;
          if (!response.ok) {
            statusUpload.textContent = "Failed";
            const detailMessage = [
              payload.error || "Transcription failed.",
              requestId !== "—" ? `Request ID: ${requestId}` : "",
              `Status: ${response.status}`,
            ]
              .filter(Boolean)
              .join(" • ");
            throw new Error(detailMessage);
          }

          transcriptEl.value = payload.text || "";
          if (payload.text) {
            statusUpload.textContent = "Complete";
            setStatus("Transcription complete.");
            copyButton.disabled = false;
            downloadButton.disabled = false;
          } else {
            statusUpload.textContent = "No transcript";
            setStatus("No transcript returned. Please try again.", true);
          }
        } catch (error) {
          statusUpload.textContent = "Failed";
          setStatus(
            error.message,
            true,
            "Check the Netlify function logs for more details."
          );
        } finally {
          transcribeButton.disabled = false;
        }
      });

      copyButton.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(transcriptEl.value);
          setStatus("Transcript copied to clipboard.");
        } catch (error) {
          setStatus("Unable to copy transcript. Please copy manually.", true);
        }
      });

      downloadButton.addEventListener("click", () => {
        const blob = new Blob([transcriptEl.value || ""], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = "transcript.txt";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      });

      resetButton.addEventListener("click", resetFormState);
    </script>
  </body>
</html>
